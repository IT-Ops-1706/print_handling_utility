<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flatten Orchestrator — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .stat-card {
        transition: all 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .sidebar-item {
        transition: all 0.2s ease;
      }
      .sidebar-item:hover {
        background: #f8f9fa;
      }
      .sidebar-item.active {
        background: #f0fdf4;
        border-left: 3px solid #14b8a6;
        font-weight: 500;
      }
      .badge {
        padding: 3px 10px;
        border-radius: 9999px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
      }
      .badge-success {
        background: #dcfce7;
        color: #166534;
      }
      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }
      .badge-info {
        background: #dbeafe;
        color: #1e40af;
      }
      .badge-gray {
        background: #f3f4f6;
        color: #374151;
      }
      .job-row {
        transition: background 0.15s ease;
        cursor: pointer;
      }
      .job-row:hover {
        background: #f9fafb;
      }
      .filter-btn {
        transition: all 0.15s ease;
      }
      .filter-btn.active {
        background: #0f172a;
        color: white;
      }
      .log-line {
        font-family: "Consolas", "Courier New", monospace;
        font-size: 12px;
        line-height: 1.6;
      }
      .log-error {
        color: #f87171;
      }
      .log-warning {
        color: #fbbf24;
      }
      .log-info {
        color: #60a5fa;
      }
      .pulse-dot {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      .truncate-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .detail-label {
        font-size: 11px;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 4px;
      }
      .detail-value {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        word-break: break-all;
      }
      /* Timeline styles */
      .timeline {
        position: relative;
        padding-left: 32px;
      }
      .timeline::before {
        content: "";
        position: absolute;
        left: 11px;
        top: 8px;
        bottom: 8px;
        width: 2px;
        background: #e5e7eb;
        border-radius: 1px;
      }
      .timeline-item {
        position: relative;
        padding-bottom: 24px;
      }
      .timeline-item:last-child {
        padding-bottom: 0;
      }
      .timeline-dot {
        position: absolute;
        left: -32px;
        top: 2px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #e5e7eb;
        z-index: 1;
      }
      .tl-blue {
        background: #dbeafe;
        color: #1e40af;
        box-shadow: 0 0 0 2px #93c5fd;
      }
      .tl-green {
        background: #dcfce7;
        color: #166534;
        box-shadow: 0 0 0 2px #86efac;
      }
      .tl-red {
        background: #fee2e2;
        color: #991b1b;
        box-shadow: 0 0 0 2px #fca5a5;
      }
      .tl-yellow {
        background: #fef3c7;
        color: #92400e;
        box-shadow: 0 0 0 2px #fde68a;
      }
      .tl-purple {
        background: #ede9fe;
        color: #5b21b6;
        box-shadow: 0 0 0 2px #c4b5fd;
      }
      .tl-teal {
        background: #ccfbf1;
        color: #115e59;
        box-shadow: 0 0 0 2px #5eead4;
      }
      .timeline-content {
        background: #f9fafb;
        border: 1px solid #f3f4f6;
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.2s ease;
      }
      .timeline-content:hover {
        background: #f3f4f6;
        border-color: #e5e7eb;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="flex min-h-screen">
      <!-- ============================================================ -->
      <!-- SIDEBAR                                                       -->
      <!-- ============================================================ -->
      <aside
        class="w-64 bg-white border-r border-gray-200 p-6 flex flex-col flex-shrink-0"
        style="min-height: 100vh"
      >
        <div class="mb-8">
          <h1 class="text-lg font-bold text-gray-900 flex items-center gap-2">
            <i class="fas fa-layer-group text-teal-500"></i>
            Flatten Orchestrator
          </h1>
          <div class="text-xs text-gray-400 mt-1">Monitoring Dashboard</div>
        </div>
        <nav class="space-y-1 flex-1">
          <div class="text-xs font-semibold text-gray-400 mb-3">NAVIGATION</div>
          <a
            href="#"
            onclick="switchView('overview')"
            id="nav-overview"
            class="sidebar-item active flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700"
          >
            <i class="fas fa-chart-pie text-sm"></i><span>Overview</span>
          </a>
          <a
            href="#"
            onclick="switchView('jobs')"
            id="nav-jobs"
            class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700"
          >
            <i class="fas fa-list-check text-sm"></i><span>All Jobs</span>
            <span
              id="nav-job-count"
              class="ml-auto bg-teal-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden"
              >0</span
            >
          </a>
          <a
            href="#"
            onclick="switchView('failed')"
            id="nav-failed"
            class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700"
          >
            <i class="fas fa-circle-exclamation text-sm text-red-400"></i
            ><span>Failed</span>
            <span
              id="nav-fail-count"
              class="ml-auto bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden"
              >0</span
            >
          </a>
          <a
            href="#"
            onclick="switchView('logs')"
            id="nav-logs"
            class="sidebar-item flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700"
          >
            <i class="fas fa-terminal text-sm"></i><span>Logs</span>
          </a>
        </nav>
        <div class="mt-auto pt-4 border-t border-gray-100">
          <button
            onclick="refreshData()"
            class="flex items-center gap-2 text-xs text-gray-400 hover:text-teal-600 transition-colors"
          >
            <i class="fas fa-sync-alt"></i>
            Refresh Dashboard
          </button>
          <div class="text-xs text-gray-400 mt-1">
            Last updated: <span id="last-updated">—</span>
          </div>
        </div>
      </aside>

      <!-- ============================================================ -->
      <!-- MAIN CONTENT                                                  -->
      <!-- ============================================================ -->
      <main class="flex-1 p-8 overflow-auto" style="max-height: 100vh">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-900" id="page-title">
              Overview
            </h2>
            <p class="text-gray-500 text-sm mt-1" id="page-subtitle">
              Real-time orchestrator metrics
            </p>
          </div>
          <div class="flex items-center gap-3" id="header-filters">
            <div
              class="flex items-center gap-2 bg-white border border-gray-200 rounded-xl px-3 py-2"
            >
              <i class="fas fa-calendar text-gray-400 text-sm"></i>
              <input
                type="date"
                id="filter-from"
                class="text-sm border-none outline-none bg-transparent w-32"
              />
              <span class="text-gray-300">—</span>
              <input
                type="date"
                id="filter-to"
                class="text-sm border-none outline-none bg-transparent w-32"
              />
            </div>
            <div class="flex gap-1">
              <button
                onclick="setDateRange('today')"
                class="filter-btn active px-3 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                id="btn-today"
              >
                Today
              </button>
              <button
                onclick="setDateRange('week')"
                class="filter-btn px-3 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                id="btn-week"
              >
                Week
              </button>
              <button
                onclick="setDateRange('month')"
                class="filter-btn px-3 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                id="btn-month"
              >
                Month
              </button>
              <button
                onclick="setDateRange('all')"
                class="filter-btn px-3 py-2 text-xs rounded-lg bg-gray-100 text-gray-600"
                id="btn-all"
              >
                All
              </button>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- VIEW: OVERVIEW                                                -->
        <!-- ============================================================ -->
        <div id="view-overview">
          <!-- Stat Cards -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"
          >
            <div
              class="stat-card bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-5 border border-blue-200 cursor-pointer"
              onclick="switchView('jobs')"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm text-gray-600">Total Processed</span
                ><i class="fas fa-boxes-stacked text-blue-400"></i>
              </div>
              <div class="text-3xl font-bold text-gray-900" id="stat-total">
                —
              </div>
              <div class="text-xs text-blue-600 mt-1">
                Today: <span id="stat-total-today">—</span>
              </div>
            </div>
            <div
              class="stat-card bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-5 border border-green-200 cursor-pointer"
              onclick="filterByStatus('saved_to_erp')"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm text-gray-600">Completed</span
                ><i class="fas fa-circle-check text-green-400"></i>
              </div>
              <div class="text-3xl font-bold text-gray-900" id="stat-completed">
                —
              </div>
              <div class="text-xs text-green-600 mt-1">
                Today: <span id="stat-completed-today">—</span>
              </div>
            </div>
            <div
              class="stat-card bg-gradient-to-br from-red-50 to-red-100 rounded-2xl p-5 border border-red-200 cursor-pointer"
              onclick="filterByStatus('permanently_failed')"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm text-gray-600">Failed</span
                ><i class="fas fa-circle-xmark text-red-400"></i>
              </div>
              <div class="text-3xl font-bold text-gray-900" id="stat-failed">
                —
              </div>
              <div class="text-xs text-red-600 mt-1">
                Today: <span id="stat-failed-today">—</span>
              </div>
            </div>
            <div
              class="stat-card bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-2xl p-5 border border-yellow-200 cursor-pointer"
              onclick="filterByStatus('pending_retry')"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm text-gray-600">Pending Retry</span
                ><i class="fas fa-rotate text-yellow-500"></i>
              </div>
              <div class="text-3xl font-bold text-gray-900" id="stat-retry">
                —
              </div>
              <div class="text-xs text-yellow-600 mt-1">
                Retried: <span id="stat-retried">—</span>
              </div>
            </div>
            <div
              class="stat-card bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-5 border border-purple-200"
            >
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm text-gray-600">Active / In Queue</span
                ><i class="fas fa-spinner text-purple-400"></i>
              </div>
              <div class="text-3xl font-bold text-gray-900" id="stat-active">
                —
              </div>
              <div class="text-xs text-purple-600 mt-1">Processing now</div>
            </div>
          </div>

          <!-- Chart + Recent Failures -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Daily Processing Chart -->
            <div
              class="lg:col-span-2 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl p-6 text-white"
            >
              <div class="mb-4">
                <h3 class="text-lg font-semibold">Daily Processing</h3>
                <p class="text-teal-100 text-xs mt-1">
                  Completed vs Failed — driven by date filter
                </p>
              </div>
              <div class="relative" style="height: 200px">
                <canvas id="dailyChart"></canvas>
              </div>
            </div>

            <!-- Recent Failures -->
            <div
              class="lg:col-span-1 bg-white rounded-2xl p-6 border border-gray-200"
            >
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900 flex items-center gap-2">
                  <i class="fas fa-triangle-exclamation text-red-400"></i>
                  Recent Failures
                </h3>
                <button
                  onclick="switchView('failed')"
                  class="text-red-500 text-sm hover:underline"
                >
                  View all
                </button>
              </div>
              <div class="space-y-3" id="recent-failures"></div>
            </div>
          </div>

          <!-- Recent Jobs Table -->
          <div class="bg-white rounded-2xl p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-900">Recent Jobs</h3>
              <button
                onclick="switchView('jobs')"
                class="text-teal-600 text-sm hover:underline"
              >
                View all
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      lId
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      File Name
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Status
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Timestamp
                    </th>
                  </tr>
                </thead>
                <tbody id="recent-jobs-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- VIEW: ALL JOBS                                                -->
        <!-- ============================================================ -->
        <div id="view-jobs" class="hidden">
          <div class="bg-white rounded-2xl p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <h3 class="font-semibold text-gray-900">All Jobs</h3>
                <span class="text-sm text-gray-400" id="jobs-count"
                  >(0 jobs)</span
                >
              </div>
              <div class="flex items-center gap-2">
                <div class="relative">
                  <i
                    class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"
                  ></i>
                  <input
                    type="text"
                    id="job-search"
                    placeholder="Search lId, fileName..."
                    onkeyup="debounceRefresh()"
                    class="pl-8 pr-3 py-2 text-sm border border-gray-200 rounded-lg outline-none focus:border-teal-400 w-56"
                  />
                </div>
                <select
                  id="status-filter"
                  onchange="refreshData()"
                  class="text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-teal-400"
                >
                  <option value="">All Statuses</option>
                  <option value="saved_to_erp">Completed</option>
                  <option value="permanently_failed">Failed</option>
                  <option value="pending_retry">Pending Retry</option>
                  <option value="submitted">Submitted</option>
                  <option value="polling">Polling</option>
                  <option value="fetched">Fetched</option>
                </select>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      lId
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Job ID
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      File Name
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Queue ID
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Status
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Timestamp
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    ></th>
                  </tr>
                </thead>
                <tbody id="jobs-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- VIEW: FAILED                                                  -->
        <!-- ============================================================ -->
        <div id="view-failed" class="hidden">
          <div class="bg-white rounded-2xl p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-circle-exclamation text-red-400"></i> Failed
                Jobs
              </h3>
              <span class="text-sm text-gray-400" id="failed-count"
                >(0 jobs)</span
              >
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      lId
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Job ID
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      File Name
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Error Type
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Error
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Retries
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    >
                      Failed At
                    </th>
                    <th
                      class="text-left py-3 px-3 text-xs font-semibold text-gray-500"
                    ></th>
                  </tr>
                </thead>
                <tbody id="failed-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- VIEW: LOGS                                                    -->
        <!-- ============================================================ -->
        <div id="view-logs" class="hidden">
          <div class="bg-white rounded-2xl border border-gray-200">
            <div
              class="flex items-center justify-between p-6 border-b border-gray-200"
            >
              <h3 class="font-semibold text-gray-900 flex items-center gap-2">
                <i class="fas fa-terminal text-gray-500"></i> Orchestrator Logs
              </h3>
              <div class="flex items-center gap-2">
                <select
                  id="log-file-select"
                  onchange="loadLogs()"
                  class="text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-teal-400"
                >
                  <option value="orchestrator.log">Today (current)</option>
                </select>
                <input
                  type="text"
                  id="log-search"
                  placeholder="Filter logs..."
                  class="text-sm border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-teal-400 w-56"
                />
                <button
                  onclick="loadLogs()"
                  class="px-3 py-2 bg-gray-900 text-white rounded-lg text-sm hover:bg-gray-800"
                >
                  <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
              </div>
            </div>
            <div
              class="p-4 bg-gray-900 rounded-b-2xl overflow-auto"
              style="max-height: 70vh"
            >
              <pre
                id="log-output"
                class="text-gray-300 log-line whitespace-pre-wrap"
              ></pre>
            </div>
          </div>
        </div>

        <!-- ============================================================ -->
        <!-- VIEW: JOB DETAIL (replaces modal — full page with sidebar)    -->
        <!-- ============================================================ -->
        <div id="view-detail" class="hidden">
          <!-- Back button -->
          <button
            onclick="goBackFromDetail()"
            class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-800 mb-4"
          >
            <i class="fas fa-arrow-left"></i> Back to list
          </button>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Metadata Card -->
            <div class="lg:col-span-1">
              <div class="bg-white rounded-2xl border border-gray-200 p-6">
                <div class="flex items-center gap-3 mb-6">
                  <div
                    id="detail-status-icon"
                    class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"
                  >
                    <i class="fas fa-circle-check text-green-500 text-xl"></i>
                  </div>
                  <div>
                    <div
                      class="text-lg font-bold text-gray-900"
                      id="detail-lid"
                    >
                      —
                    </div>
                    <div id="detail-status-badge"></div>
                  </div>
                </div>

                <div class="space-y-4" id="detail-fields"></div>
              </div>

              <!-- Error Card (conditional) -->
              <div
                id="detail-error-card"
                class="hidden mt-4 bg-red-50 rounded-2xl border border-red-200 p-6"
              >
                <h4
                  class="font-semibold text-red-800 flex items-center gap-2 mb-3"
                >
                  <i class="fas fa-triangle-exclamation"></i> Error Details
                </h4>
                <div class="space-y-3" id="detail-error-fields"></div>
              </div>
            </div>

            <!-- Right: Processing Timeline -->
            <div class="lg:col-span-2">
              <div class="bg-white rounded-2xl border border-gray-200">
                <div
                  class="flex items-center justify-between p-5 border-b border-gray-200"
                >
                  <h4
                    class="font-semibold text-gray-900 flex items-center gap-2"
                  >
                    <i class="fas fa-timeline text-teal-500"></i> Processing
                    Timeline
                  </h4>
                  <span class="text-xs text-gray-400" id="detail-timeline-count"
                    >0 milestones</span
                  >
                </div>
                <div
                  class="p-6 overflow-auto"
                  style="max-height: 65vh"
                  id="detail-timeline-container"
                >
                  <div class="text-sm text-gray-400 text-center py-8">
                    Loading timeline...
                  </div>
                </div>
              </div>

              <!-- Collapsible Raw Logs (developer mode) -->
              <div
                class="mt-4 bg-white rounded-2xl border border-gray-200 overflow-hidden"
              >
                <button
                  onclick="toggleRawLogs()"
                  id="raw-logs-toggle"
                  class="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 transition-colors"
                >
                  <div
                    class="flex items-center gap-2 text-sm font-medium text-gray-600"
                  >
                    <i class="fas fa-terminal text-gray-400"></i> Raw Log Output
                    <span class="text-xs text-gray-400 font-normal"
                      >(developer)</span
                    >
                  </div>
                  <i
                    id="raw-logs-chevron"
                    class="fas fa-chevron-down text-gray-400 text-xs transition-transform"
                  ></i>
                </button>
                <div id="raw-logs-panel" class="hidden">
                  <div class="border-t border-gray-200"></div>
                  <div
                    class="flex items-center justify-between px-4 py-2 bg-gray-50"
                  >
                    <span class="text-xs text-gray-400" id="detail-log-count"
                      >0 entries</span
                    >
                  </div>
                  <div
                    class="p-4 bg-gray-900 rounded-b-2xl overflow-auto"
                    style="max-height: 50vh"
                  >
                    <pre
                      id="detail-log-output"
                      class="text-gray-300 log-line whitespace-pre-wrap"
                    >
Logs not loaded.</pre
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ====================================================================
      // State
      // ====================================================================
      let currentView = "overview";
      let previousView = "overview";
      let debounceTimer = null;
      let dailyChart = null;
      const REFRESH_MS = 15000;

      // ====================================================================
      // Helpers
      // ====================================================================
      function escapeHtml(s) {
        const d = document.createElement("div");
        d.appendChild(document.createTextNode(s));
        return d.innerHTML;
      }
      function formatTime(ts) {
        if (!ts) return "—";
        try {
          return new Date(ts).toLocaleString("en-IN", {
            day: "2-digit",
            month: "short",
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          });
        } catch {
          return ts;
        }
      }
      function truncate(s, len) {
        return !s ? "—" : s.length > len ? s.substring(0, len) + "..." : s;
      }
      function today() {
        return new Date().toISOString().split("T")[0];
      }

      function statusBadge(status) {
        const map = {
          saved_to_erp: ["Completed", "badge-success"],
          permanently_failed: ["Failed", "badge-danger"],
          pending_retry: ["Retry", "badge-warning"],
          submitted: ["Submitted", "badge-info"],
          polling: ["Polling", "badge-info"],
          fetched: ["Fetched", "badge-gray"],
        };
        const [label, cls] = map[status] || [status || "—", "badge-gray"];
        return `<span class="badge ${cls}">${label}</span>`;
      }

      function statusIcon(status) {
        if (status === "saved_to_erp")
          return ["bg-green-100", "fas fa-circle-check text-green-500"];
        if (status === "permanently_failed")
          return ["bg-red-100", "fas fa-circle-xmark text-red-500"];
        if (status === "pending_retry")
          return ["bg-yellow-100", "fas fa-rotate text-yellow-500"];
        return ["bg-blue-100", "fas fa-spinner text-blue-500"];
      }

      // ====================================================================
      // Date Range
      // ====================================================================
      function setDateRange(range) {
        const now = new Date();
        let from = "",
          to = today();
        if (range === "today") {
          from = today();
        } else if (range === "week") {
          const d = new Date(now);
          d.setDate(d.getDate() - 7);
          from = d.toISOString().split("T")[0];
        } else if (range === "month") {
          const d = new Date(now);
          d.setMonth(d.getMonth() - 1);
          from = d.toISOString().split("T")[0];
        } else {
          from = "";
          to = "";
        }
        document.getElementById("filter-from").value = from;
        document.getElementById("filter-to").value = to;
        document
          .querySelectorAll(".filter-btn")
          .forEach((b) => b.classList.remove("active"));
        const btn = document.getElementById("btn-" + range);
        if (btn) btn.classList.add("active");
        refreshData();
      }

      // ====================================================================
      // Navigation
      // ====================================================================
      function switchView(view) {
        if (currentView !== "detail") previousView = currentView;
        currentView = view;
        ["overview", "jobs", "failed", "logs", "detail"].forEach((v) => {
          document
            .getElementById("view-" + v)
            .classList.toggle("hidden", v !== view);
        });
        ["overview", "jobs", "failed", "logs"].forEach((v) => {
          const nav = document.getElementById("nav-" + v);
          if (nav) nav.classList.toggle("active", v === view);
        });
        const titles = {
          overview: ["Overview", "Real-time orchestrator metrics"],
          jobs: ["All Jobs", "Complete list of all processed jobs"],
          failed: ["Failed Jobs", "Jobs that permanently failed"],
          logs: ["Logs", "Live orchestrator log output"],
          detail: ["Job Details", "Full metadata and related logs"],
        };
        document.getElementById("page-title").textContent = titles[view][0];
        document.getElementById("page-subtitle").textContent = titles[view][1];
        document
          .getElementById("header-filters")
          .classList.toggle("hidden", view === "detail");
        if (view === "logs") loadLogs();
        else if (view !== "detail") refreshData();
      }

      function filterByStatus(status) {
        switchView("jobs");
        document.getElementById("status-filter").value = status;
        refreshData();
      }

      function goBackFromDetail() {
        switchView(previousView || "jobs");
      }

      // ====================================================================
      // API Calls
      // ====================================================================
      function buildDateParams() {
        const from = document.getElementById("filter-from").value;
        const to = document.getElementById("filter-to").value;
        const p = new URLSearchParams();
        if (from) p.set("from", from);
        if (to) p.set("to", to);
        return p;
      }
      async function fetchStats() {
        return (await fetch("/api/stats?" + buildDateParams())).json();
      }
      async function fetchJobs(status, search) {
        const p = buildDateParams();
        if (status) p.set("status", status);
        if (search) p.set("search", search);
        return (await fetch("/api/jobs?" + p)).json();
      }
      async function fetchLogs(search, jobId, file) {
        const p = new URLSearchParams({ lines: "500" });
        if (search) p.set("search", search);
        if (jobId) p.set("job_id", jobId);
        if (file) p.set("file", file);
        return (await fetch("/api/logs?" + p)).json();
      }

      // ====================================================================
      // Render: Overview
      // ====================================================================
      async function renderOverview() {
        const { filtered: s, today: t } = await fetchStats();
        document.getElementById("stat-total").textContent = s.total;
        document.getElementById("stat-total-today").textContent = t.total;
        document.getElementById("stat-completed").textContent = s.completed;
        document.getElementById("stat-completed-today").textContent =
          t.completed;
        document.getElementById("stat-failed").textContent = s.failed;
        document.getElementById("stat-failed-today").textContent = t.failed;
        document.getElementById("stat-retry").textContent = s.pending_retry;
        document.getElementById("stat-retried").textContent = s.retried;
        document.getElementById("stat-active").textContent = s.active;

        if (s.total > 0) {
          const el = document.getElementById("nav-job-count");
          el.textContent = s.total;
          el.classList.remove("hidden");
        }
        if (s.failed > 0) {
          const el = document.getElementById("nav-fail-count");
          el.textContent = s.failed;
          el.classList.remove("hidden");
        }

        // Recent jobs
        const jobsData = await fetchJobs(null, null);
        document.getElementById("recent-jobs-body").innerHTML = jobsData.jobs
          .slice(0, 8)
          .map(
            (j) => `
        <tr class="job-row border-b border-gray-100" onclick='openDetail(${JSON.stringify(j).replace(/'/g, "&#39;")})'>
            <td class="py-3 px-3 text-sm font-medium text-gray-900">${j.lId || "—"}</td>
            <td class="py-3 px-3 text-sm text-gray-600 truncate-cell" title="${escapeHtml(j.fileName || "")}">${truncate(j.fileName, 35)}</td>
            <td class="py-3 px-3">${statusBadge(j.status)}</td>
            <td class="py-3 px-3 text-sm text-gray-500">${formatTime(j.completed_at || j.failed_at || j.submitted_at)}</td>
        </tr>`,
          )
          .join("");

        // Recent failures
        const failData = await fetchJobs("permanently_failed", null);
        const failEl = document.getElementById("recent-failures");
        const failures = failData.jobs.slice(0, 5);
        if (!failures.length) {
          failEl.innerHTML =
            '<div class="text-sm text-gray-400 text-center py-6">No failures</div>';
        } else {
          failEl.innerHTML = failures
            .map(
              (j) => `
            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg cursor-pointer" onclick='openDetail(${JSON.stringify(j).replace(/'/g, "&#39;")})'>
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-red-100 rounded-full flex items-center justify-center"><i class="fas fa-xmark text-red-500 text-sm"></i></div>
                    <div>
                        <div class="font-medium text-sm truncate-cell" style="max-width:140px;" title="${escapeHtml(j.fileName || "")}">${truncate(j.fileName, 20)}</div>
                        <div class="text-xs text-gray-500">lId: ${j.lId}</div>
                    </div>
                </div>
                <div class="text-xs text-gray-400">${formatTime(j.failed_at)}</div>
            </div>`,
            )
            .join("");
        }

        loadChart();
      }

      // ====================================================================
      // Render: Chart (driven by main date filter)
      // ====================================================================
      async function loadChart() {
        const data = await (
          await fetch("/api/chart?" + buildDateParams())
        ).json();

        const ctx = document.getElementById("dailyChart");
        if (dailyChart) dailyChart.destroy();

        // Format labels to short date
        const labels = data.labels.map((d) => {
          const dt = new Date(d);
          return dt.toLocaleDateString("en-IN", {
            day: "2-digit",
            month: "short",
          });
        });

        dailyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Completed",
                data: data.completed,
                backgroundColor: "rgba(255,255,255,0.6)",
                borderRadius: 4,
                barPercentage: 0.6,
              },
              {
                label: "Failed",
                data: data.failed,
                backgroundColor: "rgba(248,113,113,0.7)",
                borderRadius: 4,
                barPercentage: 0.6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  color: "rgba(255,255,255,0.8)",
                  font: { size: 11 },
                  boxWidth: 12,
                  padding: 16,
                },
              },
              tooltip: {
                backgroundColor: "#0f172a",
                titleFont: { size: 12 },
                bodyFont: { size: 12 },
                padding: 10,
                cornerRadius: 8,
              },
            },
            scales: {
              y: {
                display: true,
                beginAtZero: true,
                ticks: {
                  color: "rgba(255,255,255,0.5)",
                  font: { size: 10 },
                  stepSize: 1,
                },
                grid: { color: "rgba(255,255,255,0.1)" },
              },
              x: {
                grid: { display: false },
                ticks: { color: "rgba(255,255,255,0.6)", font: { size: 10 } },
                border: { display: false },
              },
            },
          },
        });
      }

      // ====================================================================
      // Toggle Raw Logs Panel
      // ====================================================================
      function toggleRawLogs() {
        const panel = document.getElementById("raw-logs-panel");
        const chevron = document.getElementById("raw-logs-chevron");
        const isHidden = panel.classList.toggle("hidden");
        chevron.style.transform = isHidden ? "" : "rotate(180deg)";
      }

      // ====================================================================
      // Render: All Jobs
      // ====================================================================
      async function renderJobs() {
        const status = document.getElementById("status-filter").value;
        const search = document.getElementById("job-search").value;
        const data = await fetchJobs(status, search);
        document.getElementById("jobs-count").textContent =
          `(${data.count} jobs)`;
        document.getElementById("jobs-table-body").innerHTML = data.jobs
          .map(
            (j) => `
        <tr class="job-row border-b border-gray-100" onclick='openDetail(${JSON.stringify(j).replace(/'/g, "&#39;")})'>
            <td class="py-3 px-3 text-sm font-medium text-gray-900">${j.lId || "—"}</td>
            <td class="py-3 px-3 text-sm text-gray-600">${j.jobId || "—"}</td>
            <td class="py-3 px-3 text-sm text-gray-600 truncate-cell" title="${escapeHtml(j.fileName || "")}">${truncate(j.fileName, 28)}</td>
            <td class="py-3 px-3 text-xs text-gray-500 font-mono">${truncate(j.print_queue_job_id, 18) || "—"}</td>
            <td class="py-3 px-3">${statusBadge(j.status)}</td>
            <td class="py-3 px-3 text-sm text-gray-500">${formatTime(j.completed_at || j.failed_at || j.submitted_at)}</td>
            <td class="py-3 px-3"><i class="fas fa-chevron-right text-gray-300 text-xs"></i></td>
        </tr>`,
          )
          .join("");
      }

      // ====================================================================
      // Render: Failed
      // ====================================================================
      async function renderFailed() {
        const data = await fetchJobs("permanently_failed", null);
        document.getElementById("failed-count").textContent =
          `(${data.count} jobs)`;
        document.getElementById("failed-table-body").innerHTML = data.jobs
          .map(
            (j) => `
        <tr class="job-row border-b border-gray-100" onclick='openDetail(${JSON.stringify(j).replace(/'/g, "&#39;")})'>
            <td class="py-3 px-3 text-sm font-medium text-gray-900">${j.lId || "—"}</td>
            <td class="py-3 px-3 text-sm text-gray-600">${j.jobId || "—"}</td>
            <td class="py-3 px-3 text-sm text-gray-600 truncate-cell" title="${escapeHtml(j.fileName || "")}">${truncate(j.fileName, 22)}</td>
            <td class="py-3 px-3"><span class="badge badge-danger">${j.error_type || "—"}</span></td>
            <td class="py-3 px-3 text-sm text-red-600 truncate-cell" title="${escapeHtml(j.error || "")}">${truncate(j.error, 35)}</td>
            <td class="py-3 px-3 text-sm text-gray-500">${j.retry_count || 0}</td>
            <td class="py-3 px-3 text-sm text-gray-500">${formatTime(j.failed_at)}</td>
            <td class="py-3 px-3"><i class="fas fa-chevron-right text-gray-300 text-xs"></i></td>
        </tr>`,
          )
          .join("");
      }

      // ====================================================================
      // Render: Logs
      // ====================================================================
      async function loadLogFiles() {
        try {
          const data = await (await fetch("/api/log-files")).json();
          const sel = document.getElementById("log-file-select");
          sel.innerHTML = data.files
            .map(
              (f) =>
                `<option value="${f.file}">${escapeHtml(f.label)}</option>`,
            )
            .join("");
        } catch (e) {
          console.error("Failed to load log files", e);
        }
      }

      async function loadLogs() {
        const search = document.getElementById("log-search").value;
        const file = document.getElementById("log-file-select").value;
        const data = await fetchLogs(search, null, file);
        const el = document.getElementById("log-output");
        el.innerHTML = data.lines
          .map((line) => {
            let cls = "";
            if (line.includes("ERROR")) cls = "log-error";
            else if (line.includes("WARNING")) cls = "log-warning";
            else if (line.includes("INFO")) cls = "log-info";
            return `<span class="${cls}">${escapeHtml(line)}</span>`;
          })
          .join("\n");
        el.parentElement.scrollTop = el.parentElement.scrollHeight;
      }

      // ====================================================================
      // Job Detail (full-page view with Timeline)
      // ====================================================================

      function timelineColorClass(color) {
        const m = {
          blue: "tl-blue",
          green: "tl-green",
          red: "tl-red",
          yellow: "tl-yellow",
          purple: "tl-purple",
          teal: "tl-teal",
        };
        return m[color] || "tl-blue";
      }

      function formatTimelineTs(ts) {
        if (!ts) return "";
        try {
          const parts = ts.split(" ");
          return parts[1] || ts; // Return just HH:MM:SS
        } catch {
          return ts;
        }
      }

      async function openDetail(job) {
        switchView("detail");

        // Status icon
        const [iconBg, iconCls] = statusIcon(job.status);
        document.getElementById("detail-status-icon").className =
          `w-12 h-12 ${iconBg} rounded-full flex items-center justify-center`;
        document.getElementById("detail-status-icon").innerHTML =
          `<i class="${iconCls} text-xl"></i>`;
        document.getElementById("detail-lid").textContent =
          `lId: ${job.lId || "—"}`;
        document.getElementById("detail-status-badge").innerHTML = statusBadge(
          job.status,
        );

        // Metadata fields
        const fields = [
          ["Job ID", job.jobId],
          ["File Name", job.fileName],
          ["Print Queue ID", job.print_queue_job_id],
          ["Doc Type", job.flatten_docType],
          ["Retry Count", job.retry_count],
          ["Submitted At", formatTime(job.submitted_at)],
          ["Completed At", formatTime(job.completed_at)],
          ["Failed At", formatTime(job.failed_at)],
        ].filter(([, v]) => v !== undefined && v !== null && v !== "—");

        document.getElementById("detail-fields").innerHTML = fields
          .map(
            ([label, value]) => `
        <div class="pb-3 border-b border-gray-100 last:border-0">
            <div class="detail-label">${label}</div>
            <div class="detail-value">${escapeHtml(String(value))}</div>
        </div>`,
          )
          .join("");

        // Error card
        const errCard = document.getElementById("detail-error-card");
        if (job.error || job.error_type) {
          errCard.classList.remove("hidden");
          document.getElementById("detail-error-fields").innerHTML = [
            ["Error Type", job.error_type],
            ["Error Message", job.error],
          ]
            .filter(([, v]) => v)
            .map(
              ([label, value]) => `
            <div>
                <div class="text-xs text-red-400 font-semibold mb-1">${label}</div>
                <div class="text-sm text-red-900">${escapeHtml(String(value))}</div>
            </div>`,
            )
            .join("");
        } else {
          errCard.classList.add("hidden");
        }

        // Processing Timeline
        const container = document.getElementById("detail-timeline-container");
        const countEl = document.getElementById("detail-timeline-count");
        container.innerHTML =
          '<div class="text-sm text-gray-400 text-center py-8">Loading timeline...</div>';
        countEl.textContent = "...";

        if (job.lId) {
          try {
            const tlData = await (
              await fetch("/api/timeline?lid=" + job.lId)
            ).json();
            countEl.textContent = tlData.count + " milestones";

            if (tlData.milestones.length > 0) {
              container.innerHTML =
                '<div class="timeline">' +
                tlData.milestones
                  .map(
                    (m) => `
                <div class="timeline-item">
                  <div class="timeline-dot ${timelineColorClass(m.color)}">
                    <i class="fas fa-${m.icon}"></i>
                  </div>
                  <div class="timeline-content">
                    <div class="flex items-center justify-between mb-1">
                      <div class="font-semibold text-sm text-gray-900">${escapeHtml(m.title)}</div>
                      <div class="text-xs text-gray-400 font-mono">${formatTimelineTs(m.timestamp)}</div>
                    </div>
                    <div class="text-xs text-gray-500">${escapeHtml(m.detail)}</div>
                  </div>
                </div>
              `,
                  )
                  .join("") +
                "</div>";
            } else {
              container.innerHTML =
                '<div class="text-sm text-gray-400 text-center py-8"><i class="fas fa-info-circle mr-2"></i>No timeline milestones found for this job.</div>';
            }
          } catch (e) {
            container.innerHTML =
              '<div class="text-sm text-red-400 text-center py-8">Failed to load timeline.</div>';
            console.error("Timeline error:", e);
          }
        } else {
          container.innerHTML =
            '<div class="text-sm text-gray-400 text-center py-8">No lId available to build timeline.</div>';
          countEl.textContent = "0 milestones";
        }

        // Reset collapsible raw logs panel (collapsed by default)
        document.getElementById("raw-logs-panel").classList.add("hidden");
        document.getElementById("raw-logs-chevron").style.transform = "";
        const logEl = document.getElementById("detail-log-output");
        const logCountEl = document.getElementById("detail-log-count");
        logEl.textContent = "Loading logs...";
        logCountEl.textContent = "...";

        // Load raw logs in background
        if (job.lId) {
          try {
            const logData = await fetchLogs(null, String(job.lId));
            logCountEl.textContent = logData.count + " entries";
            if (logData.lines.length > 0) {
              logEl.innerHTML = logData.lines
                .map((line) => {
                  let cls = "";
                  if (line.includes("ERROR")) cls = "log-error";
                  else if (line.includes("WARNING")) cls = "log-warning";
                  else if (line.includes("INFO")) cls = "log-info";
                  return `<span class="${cls}">${escapeHtml(line)}</span>`;
                })
                .join("\n");
            } else {
              logEl.textContent = "No related log entries found for this job.";
            }
          } catch (e) {
            logEl.textContent = "Failed to load logs.";
            console.error("Log load error:", e);
          }
        } else {
          logEl.textContent = "No lId available to search logs.";
          logCountEl.textContent = "0 entries";
        }
      }

      // ====================================================================
      // Data refresh
      // ====================================================================
      function debounceRefresh() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(refreshData, 300);
      }

      async function refreshData() {
        try {
          if (currentView === "overview") await renderOverview();
          else if (currentView === "jobs") await renderJobs();
          else if (currentView === "failed") await renderFailed();
          else if (currentView === "logs") await loadLogs();
          document.getElementById("last-updated").textContent =
            new Date().toLocaleTimeString("en-IN", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
        } catch (err) {
          console.error("Refresh error:", err);
        }
      }

      // ====================================================================
      // Init
      // ====================================================================
      document.addEventListener("DOMContentLoaded", () => {
        setDateRange("week");
        loadLogFiles();
        document
          .getElementById("filter-from")
          .addEventListener("change", () => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            refreshData();
          });
        document.getElementById("filter-to").addEventListener("change", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("active"));
          refreshData();
        });
        document.getElementById("log-search").addEventListener("keyup", (e) => {
          if (e.key === "Enter") loadLogs();
        });
      });
    </script>
  </body>
</html>
